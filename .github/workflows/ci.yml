name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-rls:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositório
        uses: actions/checkout@v4

      - name: Instalar Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: '2.20.3'   # ou deixar vazio para versão default

      - name: Instalar cliente PostgreSQL e jq
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client jq

      - name: Iniciar Supabase local
        run: supabase start

      - name: Aguardar Postgres ficar pronto
        run: |
          STATUS="$(supabase status --json)"
          DB_URL="$(jq -r .db.url <<<"$STATUS")"
          HOST="$(sed -E 's|postgresql://[^@]+@([^:]+):([0-9]+)/.*|\1|' <<<"$DB_URL")"
          PORT="$(sed -E 's|postgresql://[^@]+@([^:]+):([0-9]+)/.*|\2|' <<<"$DB_URL")"
          echo "Aguardando Postgres em $HOST:$PORT"
          until pg_isready -h "$HOST" -p "$PORT" -U postgres; do
            echo -n "."
            sleep 1
          done

      - name: Resetar banco e aplicar migrations
        run: supabase db reset --local

      - name: Aguardar Postgres após reset
        run: |
          until pg_isready -h "$HOST" -p "$PORT" -U postgres; do
            echo -n "."
            sleep 1
          done

      - name: Executar testes de RLS
        env:
          PGPASSWORD: postgres
        run: |
          psql -h "$HOST" -p "$PORT" -U postgres -d postgres \
            -f scripts/test_rls.sql

      - name: Derrubar Supabase local
        if: always()
        run: supabase stop
